"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[1383],{8047:function(e,t,n){n.r(t),n.d(t,{contentTitle:function(){return p},default:function(){return m},frontMatter:function(){return u},metadata:function(){return c},toc:function(){return h}});var a=n(5773),r=n(808),i=(n(7378),n(5318)),o=n(517),s=n(7637),l=["components"],u={id:"cache-behavior",title:"Cache Behavior",sidebar_label:"Cache Behavior",hide_title:!0,description:"RTK Query > Usage > Cache Behavior: defaults, cache lifetimes, and tradeoffs"},p=void 0,c={unversionedId:"rtk-query/usage/cache-behavior",id:"rtk-query/usage/cache-behavior",isDocsHomePage:!1,title:"Cache Behavior",description:"RTK Query > Usage > Cache Behavior: defaults, cache lifetimes, and tradeoffs",source:"@site/../docs/rtk-query/usage/cache-behavior.mdx",sourceDirName:"rtk-query/usage",slug:"/rtk-query/usage/cache-behavior",permalink:"/rtk-query/usage/cache-behavior",tags:[],version:"current",lastUpdatedAt:1656208204,formattedLastUpdatedAt:"6/26/2022",frontMatter:{id:"cache-behavior",title:"Cache Behavior",sidebar_label:"Cache Behavior",hide_title:!0,description:"RTK Query > Usage > Cache Behavior: defaults, cache lifetimes, and tradeoffs"},sidebar:"docs",previous:{title:"Mutations",permalink:"/rtk-query/usage/mutations"},next:{title:"Automated Re-fetching",permalink:"/rtk-query/usage/automated-refetching"}},h=[{value:"Default Cache Behavior",id:"default-cache-behavior",children:[{value:"Cache lifetime &amp; subscription example",id:"cache-lifetime--subscription-example",children:[],level:3}],level:2},{value:"Manipulating Cache Behavior",id:"manipulating-cache-behavior",children:[{value:"Reducing subscription time with <code>keepUnusedDataFor</code>",id:"reducing-subscription-time-with-keepunuseddatafor",children:[],level:3},{value:"Re-fetching on demand with <code>refetch</code>/<code>initiate</code>",id:"re-fetching-on-demand-with-refetchinitiate",children:[],level:3},{value:"Encouraging re-fetching with <code>refetchOnMountOrArgChange</code>",id:"encouraging-re-fetching-with-refetchonmountorargchange",children:[],level:3},{value:"Re-fetching on window focus with <code>refetchOnFocus</code>",id:"re-fetching-on-window-focus-with-refetchonfocus",children:[],level:3},{value:"Re-fetching on network reconnection with <code>refetchOnReconnect</code>",id:"re-fetching-on-network-reconnection-with-refetchonreconnect",children:[],level:3},{value:"Re-fetching after mutations by invalidating cache tags",id:"re-fetching-after-mutations-by-invalidating-cache-tags",children:[],level:3}],level:2},{value:"Tradeoffs",id:"tradeoffs",children:[{value:"No Normalized or De-duplicated Cache",id:"no-normalized-or-de-duplicated-cache",children:[],level:3},{value:"Further information",id:"further-information",children:[],level:3}],level:2},{value:"Examples",id:"examples",children:[{value:"Cache Subscription Lifetime Demo",id:"cache-subscription-lifetime-demo",children:[],level:3}],level:2}],d={toc:h};function m(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"cache-behavior"},"Cache Behavior"),(0,i.kt)("p",null,"A key feature of RTK Query is its management of cached data. When data is fetched from the server, RTK Query will store the data in the Redux store as a 'cache'. When an additional request is performed for the same data, RTK Query will provide the existing cached data rather than sending an additional request to the server."),(0,i.kt)("p",null,"RTK Query provides a number of concepts and tools to manipulate the cache behaviour and adjust it to your needs."),(0,i.kt)("h2",{id:"default-cache-behavior"},"Default Cache Behavior"),(0,i.kt)("p",null,"RTK Query\uc5d0\uc11c\ub294 \ub2e4\uc74c\uc744 \uae30\ubc18\uc73c\ub85c \uce90\uc2f1\uc774 \uc9c4\ud589\ub429\ub2c8\ub2e4:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"API endpoint \uc815\uc758"),(0,i.kt)("li",{parentName:"ul"},"components\ub4e4\uc774 endpoint\uc758 \uad6c\ub3c5\uc5d0 \uc0ac\uc6a9\ud55c \uc9c1\ub82c\ud654\ub41c query parameters"),(0,i.kt)("li",{parentName:"ul"},"\ud65c\uc131\ud654 \ub41c \uad6c\ub3c5 reference \uac2f\uc218")),(0,i.kt)("p",null,"\uad6c\ub3c5\uc774 \uc2dc\uc791\ub418\uba74, endpoint\uc5d0 \uc0ac\uc6a9\ub41c parameters\ub4e4\uc774 \uc9c1\ub82c\ud654\ub418\uba70 \uc694\uccad\uc5d0 \ub300\ud55c ",(0,i.kt)("inlineCode",{parentName:"p"},"queryCacheKey"),"\ub85c \ub0b4\ubd80\uc801\uc73c\ub85c \uc800\uc7a5\ub429\ub2c8\ub2e4. \ud5a5\ud6c4 \ub3d9\uc77c\ud55c ",(0,i.kt)("inlineCode",{parentName:"p"},"queryCacheKey"),"\ub97c \uc0dd\uc131\ud558\ub294 \uc694\uccad (i.e. called with the same parameters, factoring serialization)\uc740 \uc6d0\ubcf8\uc5d0 \ub530\ub77c \uc911\ubcf5 \uc81c\uac70\ub418\uba70, \ub3d9\uc77c\ud55c \ub370\uc774\ud130 \ubc0f \uc5c5\ub370\uc774\ud2b8\ub97c \uacf5\uc720\ud569\ub2c8\ub2e4. \uc989, \ub3d9\uc77c\ud55c \uc694\uccad\uc744 \uc0ac\uc6a9\ud558\ub294 \ub450\uac1c\uc758 \uac1c\ubcc4 components\ub4e4\uc740 \ub3d9\uc77c\ud55c \uce90\uc2dc\ub41c \ub370\uc774\ud130\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4."),(0,i.kt)("p",null,"\uc694\uccad\uc774 \uc2dc\ub3c4\ub420 \ub54c \ub370\uc774\ud130\uac00 \uc774\ubbf8 \uce90\uc2dc\uc5d0 \uc788\ub294 \uacbd\uc6b0 \ud574\ub2f9 \ub370\uc774\ud130\uac00 \uc81c\uacf5\ub418\uace0 \uc0c8 \uc694\uccad\uc774 \uc11c\ubc84\ub85c \uc804\uc1a1\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4. \uadf8\ub807\uc9c0 \uc54a\uace0 \ub370\uc774\ud130\uac00 \uce90\uc2dc\uc5d0 \uc5c6\uc73c\uba74 \uc0c8 \uc694\uccad\uc774 \uc804\uc1a1\ub418\uace0 \ubc18\ud658\ub41c \uc751\ub2f5\uc740 \uce90\uc2dc\uc5d0 \uc800\uc7a5\ub429\ub2c8\ub2e4."),(0,i.kt)("p",null,"Subscriptions are reference-counted. Additional subscriptions that ask for the same endpoint+params increment the reference count. As long as there is an active 'subscription' to the data (e.g. if a component is mounted that calls a ",(0,i.kt)("inlineCode",{parentName:"p"},"useQuery")," hook for the endpoint), then the data will remain in the cache. Once the subscription is removed (e.g. when last component subscribed to the data unmounts), after an amount of time (default 60 seconds), the data will be removed from the cache. The expiration time can be configured with the ",(0,i.kt)("inlineCode",{parentName:"p"},"keepUnusedDataFor")," property for the ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#keepunuseddatafor"},"API definition as a whole"),", as well as on a ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#keepunuseddatafor-1"},"per-endpoint")," basis."),(0,i.kt)("h3",{id:"cache-lifetime--subscription-example"},"Cache lifetime & subscription example"),(0,i.kt)("p",null,"\ucffc\ub9ac \ub9e4\uac1c\ubcc0\uc218\ub85c ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," \ub97c \uc0ac\uc6a9\ud558\ub294 \uc5d4\ub4dc\ud3ec\uc778\ud2b8\uc640, \ud574\ub2f9 \uc5d4\ub4dc\ud3ec\uc778\ud2b8\uc5d0\uc11c \ub370\uc774\ud130\ub97c \uc694\uccad\ud558\ub294 4\uac1c\uc758 \uad6c\uc131\uc694\uc18c\uac00 \ud0d1\uc7ac\ub418\uc5b4 \uc788\ub2e4\uace0 \uc0c1\uc0c1\ud574 \ubd05\uc2dc\ub2e4."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"no-transpile","no-transpile":!0},"import { useGetUserQuery } from './api.ts'\n\nfunction ComponentOne() {\n  // component \ub294 \ub370\uc774\ud130\ub97c \uad6c\ub3c5\ud569\ub2c8\ub2e4.\n  const { data } = useGetUserQuery(1)\n\n  return <div>...</div>\n}\n\nfunction ComponentTwo() {\n  // component \ub294 \ub370\uc774\ud130\ub97c \uad6c\ub3c5\ud569\ub2c8\ub2e4.\n  const { data } = useGetUserQuery(2)\n\n  return <div>...</div>\n}\n\nfunction ComponentThree() {\n  // component \ub294 \ub370\uc774\ud130\ub97c \uad6c\ub3c5\ud569\ub2c8\ub2e4.\n  const { data } = useGetUserQuery(3)\n\n  return <div>...</div>\n}\n\nfunction ComponentFour() {\n  // component \ub294 ComponentThree\uc640 \ub3d9\uc77c\ud55c query parameters\ub97c \uac00\uc9c0\uace0 \uc788\uae30 \ub54c\ubb38\uc5d0,\n  // *\ub3d9\uc77c\ud55c* \ub370\uc774\ud130\ub97c \uad6c\ub3c5\ud569\ub2c8\ub2e4\n  const { data } = useGetUserQuery(3)\n\n  return <div>...</div>\n}\n")),(0,i.kt)("p",null,"4\uac1c\uc758 components\uac00 endpoint\uc5d0 \uad6c\ub3c5 \ub418\uc5b4 \uc788\uc9c0\ub9cc, endpoint + query parameters\uac00 \uace0\uc720\ud55c \uc870\ud569\uc740 3\uac1c\ubfd0\uc785\ub2c8\ub2e4. query parameters ",(0,i.kt)("inlineCode",{parentName:"p"},"1")," \uacfc ",(0,i.kt)("inlineCode",{parentName:"p"},"2")," \ub294 \uac01\uac01 1\uac1c\uc758 \uad6c\ub3c5\uc790\uac00 \uc788\uc73c\ub098, ",(0,i.kt)("inlineCode",{parentName:"p"},"3"),"\uc5d0\ub294 2\uba85\uc758 \uad6c\ub3c5\uc790\uac00 \uc788\uc2b5\ub2c8\ub2e4. RTK Query\ub294 query parameters\uc640 endpoint\uc758 \uace0\uc720\ud55c \uc870\ud569\uc5d0 \ub530\ub77c \uc911\ubcf5\uc774 \uc81c\uac70\ub41c 3\ubc88\uc758 fetch\ub97c \uc9c4\ud589\ud569\ub2c8\ub2e4."),(0,i.kt)("p",null,"endpoint + query parameters\uc5d0 \ub300\ud574 \ud558\ub098 \uc774\uc0c1\uc758 \uad6c\ub3c5\uc790\uac00 \ud65c\uc131\ud654 \ub418\uc5b4\uc788\ub294 \ud55c \ub370\uc774\ud130\ub294 \uce90\uc2dc\uc5d0 \ubcf4\uad00\ub429\ub2c8\ub2e4. \ub9cc\uc57d \uad6c\ub3c5\uc790\uac00 0\uc774 \ub420 \uacbd\uc6b0, \ud0c0\uc774\uba38\uac00 \uc124\uc815\ub418\uace0, \ud0c0\uc774\uba38\uac00 \ub9cc\ub8cc\ub420 \ub54c \uae4c\uc9c0 \uc0c8 \uad6c\ub3c5\uc790\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\ub294\ub2e4\uba74 \ub370\uc774\ud130\ub294 \uce90\uc2dc\uc5d0\uc11c \uc81c\uac70\ub418\uac8c \ub429\ub2c8\ub2e4. \uae30\ubcf8 \ub9cc\ub8cc\uc2dc\uac04\uc740 60\ucd08\uc774\uba70, ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#keepunuseddatafor"},"API \uc815\uc758 \uc804\uccb4")," \ubc0f ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#keepunuseddatafor-1"},"endpoint \ubcc4")," \uae30\uc900\uc73c\ub85c \uc124\uc815\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,i.kt)("p",null,"\uc704\uc758 \uc608\uc2dc\uc5d0\uc11c 'ComponentThree'\uac00 unmounted \ub41c \ub4a4, \uc5bc\ub9c8\ub9cc\ud07c\uc758 \uc2dc\uac04\uc774 \uc9c0\ub098\ub354\ub77c\ub3c4 'ComponentFour'\uc774 \uc5ec\uc804\ud788 \uad6c\ub3c5\uc790\ub85c\uc11c \ub0a8\uc544\uc788\uc5b4, \uad6c\ub3c5\uc790\uc758 \uc218\ub294 ",(0,i.kt)("inlineCode",{parentName:"p"},"1")," \uc774\ubbc0\ub85c \uacc4\uc18d \ub370\uc774\ud130\ub294 \uce90\uc2dc\uc5d0 \ub0a8\uc544\uc788\uac8c \ub429\ub2c8\ub2e4. \uadf8\ub7ec\ub098 'ComponentFour'\uac00 unmount \ub41c\ub2e4\uba74, \uad6c\ub3c5\uc790\uc758 \uc218\ub294 ",(0,i.kt)("inlineCode",{parentName:"p"},"0")," \uc774 \ub418\uc5b4 \ub9cc\ub8cc\uc2dc\uac04\ub3d9\uc548 \uce90\uc2dc\uc5d0 \uc874\uc7ac\ud558\uac8c \ub429\ub2c8\ub2e4. \ub9cc\ub8cc\uc2dc\uac04\ub3d9\uc548 \uc0c8\ub85c\uc6b4 \uad6c\ub3c5\uc790\uac00 \uc0dd\uc131\ub418\uc9c0 \uc54a\ub294\ub2e4\uba74, \uce90\uc2dc\ub41c \ub370\uc774\ud130\ub294 \ucd5c\uc885\uc801\uc73c\ub85c \uc81c\uac70\ub429\ub2c8\ub2e4."),(0,i.kt)("h2",{id:"manipulating-cache-behavior"},"Manipulating Cache Behavior"),(0,i.kt)("p",null,"On top of the default behaviour, RTK Query provides a number of methods to re-fetch data earlier in scenarios where it should be considered invalid, or is otherwise deemed suitable to be 'refreshed'."),(0,i.kt)("h3",{id:"reducing-subscription-time-with-keepunuseddatafor"},"Reducing subscription time with ",(0,i.kt)("inlineCode",{parentName:"h3"},"keepUnusedDataFor")),(0,i.kt)("p",null,"As mentioned above under ",(0,i.kt)("a",{parentName:"p",href:"#default-cache-behavior"},"Default Cache Behavior")," and ",(0,i.kt)("a",{parentName:"p",href:"#cache-lifetime--subscription-example"},"Cache lifetime & subscription example"),", by default, data will remain in the cache for 60 seconds after the subscriber reference count hits zero."),(0,i.kt)("p",null,"This value can be configured using the ",(0,i.kt)("inlineCode",{parentName:"p"},"keepUnusedDataFor")," option for both the API definition, as well as per-endpoint. Note that the per-endpoint version, if provided, will overrule a setting on the API definition."),(0,i.kt)("p",null,"Providing a value to ",(0,i.kt)("inlineCode",{parentName:"p"},"keepUnusedDataFor")," as a number in seconds specifies how long the data should be kept in the cache after the subscriber reference count reaches zero."),(0,i.kt)(s.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"ts",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="keepUnusedDataFor configuration"',title:'"keepUnusedDataFor','configuration"':!0},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\nimport { Post } from './types'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  keepUnusedDataFor: 30,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query<Post[], number>({\n      query: () => `posts`,\n      // highlight-start\n      // configuration for an individual endpoint, overriding the api setting\n      keepUnusedDataFor: 5,\n      // highlight-end\n    }),\n  }),\n})\n"))),(0,i.kt)(o.Z,{value:"js",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="keepUnusedDataFor configuration"',title:'"keepUnusedDataFor','configuration"':!0},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  keepUnusedDataFor: 30,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query({\n      query: () => `posts`,\n      // highlight-start\n      // configuration for an individual endpoint, overriding the api setting\n      keepUnusedDataFor: 5,\n      // highlight-end\n    }),\n  }),\n})\n")))),(0,i.kt)("h3",{id:"re-fetching-on-demand-with-refetchinitiate"},"Re-fetching on demand with ",(0,i.kt)("inlineCode",{parentName:"h3"},"refetch"),"/",(0,i.kt)("inlineCode",{parentName:"h3"},"initiate")),(0,i.kt)("p",null,"In order to achieve complete granular control over re-fetching data, you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"refetch")," function returned as a result property from a ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#usequery"},(0,i.kt)("inlineCode",{parentName:"a"},"useQuery"))," or ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#usequerysubscription"},(0,i.kt)("inlineCode",{parentName:"a"},"useQuerySubscription"))," hook."),(0,i.kt)("p",null,"Calling the ",(0,i.kt)("inlineCode",{parentName:"p"},"refetch")," function will force refetch the associated query."),(0,i.kt)("p",null,"Alternatively, you can dispatch the ",(0,i.kt)("inlineCode",{parentName:"p"},"initiate")," thunk action for an endpoint, passing the option ",(0,i.kt)("inlineCode",{parentName:"p"},"forceRefetch: true")," to the thunk action creator for the same effect."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="Force refetch example"',title:'"Force',refetch:!0,'example"':!0},"import { useDispatch } from 'react-redux'\nimport { useGetPostsQuery } from './api'\n\nconst Component = () => {\n  const dispatch = useDispatch()\n  const { data, refetch } = useGetPostsQuery({ count: 5 })\n\n  function handleRefetchOne() {\n    // force re-fetches the data\n    refetch()\n  }\n\n  function handleRefetchTwo() {\n    // has the same effect as `refetch` for the associated query\n    dispatch(\n      api.endpoints.getPosts.initiate(\n        { count: 5 },\n        { subscribe: false, forceRefetch: true }\n      )\n    )\n  }\n\n  return (\n    <div>\n      <button onClick={handleRefetchOne}>Force re-fetch 1</button>\n      <button onClick={handleRefetchTwo}>Force re-fetch 2</button>\n    </div>\n  )\n}\n")),(0,i.kt)("h3",{id:"encouraging-re-fetching-with-refetchonmountorargchange"},"Encouraging re-fetching with ",(0,i.kt)("inlineCode",{parentName:"h3"},"refetchOnMountOrArgChange")),(0,i.kt)("p",null,"Queries can be encouraged to re-fetch more frequently than usual via the ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#refetchonmountorargchange"},(0,i.kt)("inlineCode",{parentName:"a"},"refetchOnMountOrArgChange"))," property. This can be passed to the endpoint as a whole, to individual hook calls, or when dispatching the ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/endpoints#initiate"},(0,i.kt)("inlineCode",{parentName:"a"},"initiate"))," action (the name of the action creator's option is ",(0,i.kt)("inlineCode",{parentName:"p"},"forceRefetch"),")."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"refetchOnMountOrArgChange")," is used to encourage re-fetching in additional situations where the default behavior would instead serve cached data."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"refetchOnMountOrArgChange")," accepts either a boolean value, or a number as time in seconds."),(0,i.kt)("p",null,"Passing ",(0,i.kt)("inlineCode",{parentName:"p"},"false")," (the default value) for this property will use the default behavior ",(0,i.kt)("a",{parentName:"p",href:"#default-cache-behavior"},"described above"),"."),(0,i.kt)("p",null,"Passing ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," for this property will cause the endpoint to always refetch when a new subscriber to the query is added. If passed to an individual hook call and not the api definition itself, then this applies only to that hook call. I.e., when the component calling the hook mounts, or the argument changes, it will always refetch, regardless of whether cached data for the endpoint + arg combination already exists."),(0,i.kt)("p",null,"Passing a ",(0,i.kt)("inlineCode",{parentName:"p"},"number")," as a value in seconds will use the following behavior:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"At the time a query subscription is created:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"if there is an existing query in the cache, it will compare the current time vs the last fulfilled timestamp for that query,"),(0,i.kt)("li",{parentName:"ul"},"It will refetch if the provided amount of time in seconds has elapsed."))),(0,i.kt)("li",{parentName:"ul"},"If there is no query, it will fetch the data."),(0,i.kt)("li",{parentName:"ul"},"If there is an existing query, but the amount of time specified since the last query has not elapsed, it will serve the existing cached data.")),(0,i.kt)(s.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"ts",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="Configuring re-fetching on subscription if data exceeds a given time"',title:'"Configuring',"re-fetching":!0,on:!0,subscription:!0,if:!0,data:!0,exceeds:!0,a:!0,given:!0,'time"':!0},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\nimport { Post } from './types'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  refetchOnMountOrArgChange: 30,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query<Post[], number>({\n      query: () => `posts`,\n    }),\n  }),\n})\n"))),(0,i.kt)(o.Z,{value:"js",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="Configuring re-fetching on subscription if data exceeds a given time"',title:'"Configuring',"re-fetching":!0,on:!0,subscription:!0,if:!0,data:!0,exceeds:!0,a:!0,given:!0,'time"':!0},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  refetchOnMountOrArgChange: 30,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query({\n      query: () => `posts`,\n    }),\n  }),\n})\n")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="Forcing refetch on component mount"',title:'"Forcing',refetch:!0,on:!0,component:!0,'mount"':!0},"import { useGetPostsQuery } from './api'\n\nconst Component = () => {\n  const { data } = useGetPostsQuery(\n    { count: 5 },\n    // highlight-start\n    // this overrules the api definition setting,\n    // forcing the query to always fetch when this component is mounted\n    { refetchOnMountOrArgChange: true }\n    // highlight-end\n  )\n\n  return <div>...</div>\n}\n")),(0,i.kt)("h3",{id:"re-fetching-on-window-focus-with-refetchonfocus"},"Re-fetching on window focus with ",(0,i.kt)("inlineCode",{parentName:"h3"},"refetchOnFocus")),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#refetchonfocus"},(0,i.kt)("inlineCode",{parentName:"a"},"refetchOnFocus"))," option allows you to control whether RTK Query will try to refetch all subscribed queries after the application window regains focus."),(0,i.kt)("p",null,"If you specify this option alongside ",(0,i.kt)("inlineCode",{parentName:"p"},"skip: true"),", this will not be evaluated until skip is false."),(0,i.kt)("p",null,"Note that this requires ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/setupListeners"},(0,i.kt)("inlineCode",{parentName:"a"},"setupListeners"))," to have been called."),(0,i.kt)("p",null,"This option is available on both the api definition with ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi"},(0,i.kt)("inlineCode",{parentName:"a"},"createApi")),", as well as on the ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#usequery"},(0,i.kt)("inlineCode",{parentName:"a"},"useQuery")),", ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#usequerysubscription"},(0,i.kt)("inlineCode",{parentName:"a"},"useQuerySubscription")),", ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#uselazyquery"},(0,i.kt)("inlineCode",{parentName:"a"},"useLazyQuery")),", and ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#uselazyquerysubscription"},(0,i.kt)("inlineCode",{parentName:"a"},"useLazyQuerySubscription"))," hooks."),(0,i.kt)(s.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"ts",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/services/api.ts"',title:'"src/services/api.ts"'},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\nimport { Post } from './types'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  refetchOnFocus: true,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query<Post[], number>({\n      query: () => `posts`,\n    }),\n  }),\n})\n"))),(0,i.kt)(o.Z,{value:"js",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="src/services/api.ts"',title:'"src/services/api.ts"'},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  refetchOnFocus: true,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query({\n      query: () => `posts`,\n    }),\n  }),\n})\n")))),(0,i.kt)(s.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"ts",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/store.ts"',title:'"src/store.ts"'},"import { configureStore } from '@reduxjs/toolkit'\nimport { setupListeners } from '@reduxjs/toolkit/query'\nimport { api } from './services/api'\n\nexport const store = configureStore({\n  reducer: {\n    [api.reducerPath]: api.reducer,\n  },\n  middleware: (gDM) => gDM().concat(api.middleware),\n})\n\n// highlight-start\n// enable listener behavior for the store\nsetupListeners(store.dispatch)\n// highlight-end\n\nexport type RootState = ReturnType<typeof store.getState>\n"))),(0,i.kt)(o.Z,{value:"js",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="src/store.ts"',title:'"src/store.ts"'},"import { configureStore } from '@reduxjs/toolkit'\nimport { setupListeners } from '@reduxjs/toolkit/query'\nimport { api } from './services/api'\n\nexport const store = configureStore({\n  reducer: {\n    [api.reducerPath]: api.reducer,\n  },\n  middleware: (gDM) => gDM().concat(api.middleware),\n})\n\n// highlight-start\n// enable listener behavior for the store\nsetupListeners(store.dispatch)\n")))),(0,i.kt)("h3",{id:"re-fetching-on-network-reconnection-with-refetchonreconnect"},"Re-fetching on network reconnection with ",(0,i.kt)("inlineCode",{parentName:"h3"},"refetchOnReconnect")),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi#refetchonreconnect"},(0,i.kt)("inlineCode",{parentName:"a"},"refetchOnReconnect"))," option on ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi"},(0,i.kt)("inlineCode",{parentName:"a"},"createApi"))," allows you to control whether RTK Query will try to refetch all subscribed queries after regaining a network connection."),(0,i.kt)("p",null,"If you specify this option alongside ",(0,i.kt)("inlineCode",{parentName:"p"},"skip: true"),", this ",(0,i.kt)("strong",{parentName:"p"},"will not be evaluated")," until ",(0,i.kt)("inlineCode",{parentName:"p"},"skip")," is false."),(0,i.kt)("p",null,"Note that this requires ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/setupListeners"},(0,i.kt)("inlineCode",{parentName:"a"},"setupListeners"))," to have been called."),(0,i.kt)("p",null,"This option is available on both the api definition with ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/createApi"},(0,i.kt)("inlineCode",{parentName:"a"},"createApi")),", as well as on the ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#usequery"},(0,i.kt)("inlineCode",{parentName:"a"},"useQuery")),", ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#usequerysubscription"},(0,i.kt)("inlineCode",{parentName:"a"},"useQuerySubscription")),", ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#uselazyquery"},(0,i.kt)("inlineCode",{parentName:"a"},"useLazyQuery")),", and ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/api/created-api/hooks#uselazyquerysubscription"},(0,i.kt)("inlineCode",{parentName:"a"},"useLazyQuerySubscription"))," hooks."),(0,i.kt)(s.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"ts",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/services/api.ts"',title:'"src/services/api.ts"'},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\nimport { Post } from './types'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  refetchOnReconnect: true,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query<Post[], number>({\n      query: () => `posts`,\n    }),\n  }),\n})\n"))),(0,i.kt)(o.Z,{value:"js",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="src/services/api.ts"',title:'"src/services/api.ts"'},"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  // highlight-start\n  // global configuration for the api\n  refetchOnReconnect: true,\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query({\n      query: () => `posts`,\n    }),\n  }),\n})\n")))),(0,i.kt)(s.Z,{groupId:"language",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"ts",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/store.ts"',title:'"src/store.ts"'},"import { configureStore } from '@reduxjs/toolkit'\nimport { setupListeners } from '@reduxjs/toolkit/query'\nimport { api } from './services/api'\n\nexport const store = configureStore({\n  reducer: {\n    [api.reducerPath]: api.reducer,\n  },\n  middleware: (gDM) => gDM().concat(api.middleware),\n})\n\n// highlight-start\n// enable listener behavior for the store\nsetupListeners(store.dispatch)\n// highlight-end\n\nexport type RootState = ReturnType<typeof store.getState>\n"))),(0,i.kt)(o.Z,{value:"js",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="src/store.ts"',title:'"src/store.ts"'},"import { configureStore } from '@reduxjs/toolkit'\nimport { setupListeners } from '@reduxjs/toolkit/query'\nimport { api } from './services/api'\n\nexport const store = configureStore({\n  reducer: {\n    [api.reducerPath]: api.reducer,\n  },\n  middleware: (gDM) => gDM().concat(api.middleware),\n})\n\n// highlight-start\n// enable listener behavior for the store\nsetupListeners(store.dispatch)\n")))),(0,i.kt)("h3",{id:"re-fetching-after-mutations-by-invalidating-cache-tags"},"Re-fetching after mutations by invalidating cache tags"),(0,i.kt)("p",null,"RTK Query uses an optional ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/usage/automated-refetching#cache-tags"},"cache tag")," system to automate re-fetching for query endpoints that have data affected by mutation endpoints."),(0,i.kt)("p",null,"See ",(0,i.kt)("a",{parentName:"p",href:"/rtk-query/usage/automated-refetching"},"Automated Re-fetching")," for full details on this concept."),(0,i.kt)("h2",{id:"tradeoffs"},"Tradeoffs"),(0,i.kt)("h3",{id:"no-normalized-or-de-duplicated-cache"},"No Normalized or De-duplicated Cache"),(0,i.kt)("p",null,"RTK Query deliberately ",(0,i.kt)("strong",{parentName:"p"},"does ",(0,i.kt)("em",{parentName:"strong"},"not")," implement a cache that would deduplicate identical items across multiple requests"),". There are several reasons for this:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A fully normalized shared-across-queries cache is a ",(0,i.kt)("em",{parentName:"li"},"hard")," problem to solve"),(0,i.kt)("li",{parentName:"ul"},"We don't have the time, resources, or interest in trying to solve that right now"),(0,i.kt)("li",{parentName:"ul"},"In many cases, simply re-fetching data when it's invalidated works well and is easier to understand"),(0,i.kt)("li",{parentName:"ul"},'At a minimum, RTKQ can help solve the general use case of "fetch some data", which is a big pain point for a lot of people')),(0,i.kt)("p",null,"As an example, say that we have an API slice with ",(0,i.kt)("inlineCode",{parentName:"p"},"getTodos")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"getTodo")," endpoints, and our components make the following queries:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"getTodos()")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"getTodos({filter: 'odd'})")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"getTodo({id: 1})"))),(0,i.kt)("p",null,"Each of these query results would include a Todo object that looks like ",(0,i.kt)("inlineCode",{parentName:"p"},"{id: 1}"),"."),(0,i.kt)("p",null,"In a fully normalized de-duplicating cache, only a single copy of this Todo object would be stored. However, RTK Query saves each query result independently in the cache. So, this would result in three separate copies of this Todo being cached in the Redux store. However, if all the endpoints are consistently providing the same tags (such as ",(0,i.kt)("inlineCode",{parentName:"p"},"{type: 'Todo', id: 1}"),"), then invalidating that tag will force all the matching endpoints to refetch their data for consistency."),(0,i.kt)("p",null,"The Redux docs have always recommended ",(0,i.kt)("a",{parentName:"p",href:"https://redux.js.org/recipes/structuring-reducers/normalizing-state-shape"},"keeping data in a normalized lookup table")," to enable easily finding items by ID and updating them in the store, and ",(0,i.kt)("a",{parentName:"p",href:"/api/createEntityAdapter"},"RTK's ",(0,i.kt)("inlineCode",{parentName:"a"},"createEntityAdapter"))," was designed to help manage normalized state. Those concepts are still valuable and don't go away. However, if you're using RTK Query to manage caching data, there's less need to manipulate the data that way yourself."),(0,i.kt)("p",null,"There are a couple additional points that can help here:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The generated query hooks have ",(0,i.kt)("a",{parentName:"li",href:"/rtk-query/api/created-api/hooks#selectfromresult"},"a ",(0,i.kt)("inlineCode",{parentName:"a"},"selectFromResult")," option")," that allow components to read individual pieces of data from a query result. As an example, a ",(0,i.kt)("inlineCode",{parentName:"li"},"<TodoList>")," component might call ",(0,i.kt)("inlineCode",{parentName:"li"},"useTodosQuery()"),", and each individual ",(0,i.kt)("inlineCode",{parentName:"li"},"<TodoListItem>")," could use the same query hook but select from the result to get the right todo object."),(0,i.kt)("li",{parentName:"ul"},"You can use the ",(0,i.kt)("a",{parentName:"li",href:"/rtk-query/api/createApi#transformresponse"},(0,i.kt)("inlineCode",{parentName:"a"},"transformResponse")," endpoint option")," to modify the fetched data so that it's ",(0,i.kt)("a",{parentName:"li",href:"/rtk-query/usage/customizing-queries#customizing-query-responses-with-transformresponse"},"stored in a different shape"),", such as using ",(0,i.kt)("inlineCode",{parentName:"li"},"createEntityAdapter")," to normalize the data ",(0,i.kt)("em",{parentName:"li"},"for this one response")," before it's inserted into the cache.")),(0,i.kt)("h3",{id:"further-information"},"Further information"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.reddit.com/r/reactjs/comments/my9vrq/redux_toolkit_v16_alpha1_rtk_query_apis/gvxi5t7/"},"Reddit: discussion of why RTKQ doesn't have a normalized cache, and tradeoffs"))),(0,i.kt)("h2",{id:"examples"},"Examples"),(0,i.kt)("h3",{id:"cache-subscription-lifetime-demo"},"Cache Subscription Lifetime Demo"),(0,i.kt)("p",null,"This example is a live demo of how the subscriber reference count and the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"keepUnusedDataFor")," interact with each other. The ",(0,i.kt)("inlineCode",{parentName:"p"},"Subscriptions")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Queries")," (including the cached data) are shown in the demo for you to visualize (note that this can also be viewed in the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/zalmoxisus/redux-devtools-extension"},"Redux Devtools Extension"),")."),(0,i.kt)("p",null,"Two components are mounted, each with the same endpoints query (",(0,i.kt)("inlineCode",{parentName:"p"},"useGetUsersQuery(2)"),"). You will be able to observe that when toggling off the components, the subscriber reference count will be reduced. After toggling off both components such that the subscriber reference count reaches zero, you will observe the cached data under the ",(0,i.kt)("inlineCode",{parentName:"p"},"Queries")," section will persist for 5 seconds (the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"keepUnusedDataFor")," provided for the endpoint in this demo). If the subscriber reference count remains at 0 for the full duration, the cached data will then be removed from the store."),(0,i.kt)("iframe",{src:"https://codesandbox.io/embed/rtk-query-cache-subscription-lifetime-example-77tn4?fontsize=12&runonclick=1&hidenavigation=1&theme=dark&module=%2Fsrc%2Fservice%2Findex.ts",style:{width:"100%",height:"800px",border:0,borderRadius:"4px",overflow:"hidden"},title:"rtk-query-cache-subscription-lifetime-example",allow:"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb",sandbox:"allow-modals allow-forms allow-popups allow-scripts allow-same-origin"}))}m.isMDXComponent=!0}}]);